/*
 * File Name: filter.c
 * Author: ckevar
 * Created: Jan 20, 2020 at 10:50AM
 */
#include "filter.h"
#include "fft.h"
#include "definition.h"

#include <stdio.h>

complex W[N - 1];				// Twiddle e^(-j2*pi/N) table;

void initFFT(short exp) {
	createTwiddleTable(W, exp);
}

void filter2Complex(complex *Hl, complex *Hr, double *hl, double *hr, unsigned short filterLenght) {
	unsigned short i;
	double2complex(Hr, hr, filterLenght);
	double2complex(Hl, hl, filterLenght);
	// Zero padding
	for(i = filterLenght; i < N; i++) {	
		Hr[i].re = 0.0;
		Hr[i].im = 0.0;

		Hl[i].re = 0.0;
		Hl[i].im = 0.0;
	}

}

void filterLRTime2Freq(complex *Hl, complex *Hr, short exp) {
	// left channel
	bit_rev(Hl, exp);	// arrenge H in a bit-reverse order
	dft(Hl, exp, W);	// perform fft

	// right channel
	bit_rev(Hr, exp);	// arrenge H in a bit-reverse order
	dft(Hr, exp, W);	// perform fft
}

void loadFiltersFront(complex *Hl, complex *Hr, short exp, unsigned short filterLenght){
	

	double hl[L] = {
		-0.000001, -0.000000, -0.000001, 0.000001, 0.000001, 0.000000, 0.000001,
		0.000000, 0.000001, -0.000001, -0.000001, -0.000001, 0.000000, 0.000001,
		0.000001, 0.000001, -0.000001, 0.000001, 0.000000, -0.000000, -0.000003,
		-0.000001, 0.000000, 0.000000, 0.000000, 0.000001, 0.000001, 0.000000,
		0.000002, -0.000000, -0.000000, 0.000002, 0.000001, 0.000000, 0.000000,
		0.000003, 0.000001, -0.000001, 0.000001, 0.000002, 0.000000, 0.000000,
		0.000001, 0.000001, -0.000001, 0.000000, 0.000000, -0.000000, 0.000001, 
		-0.000001, -0.000000, 0.000001, 0.000001, -0.000000, -0.000001, -0.000001,
		-0.000001, 0.000000, -0.000001, 0.000001, 0.000000, 0.000000, 0.000000,
		0.000001, 0.000001, 0.000001, 0.000002, 0.000002, 0.000001, 0.000001, 
		0.000001, 0.000001, 0.000000, 0.000001, -0.000000, 0.000001, -0.000002, 
		-0.000001, -0.000000, -0.000001, -0.000001, 0.000000, -0.000001, -0.000001,
		0.000002, -0.000001, 0.000000, 0.000001, -0.000001, -0.000000, 0.000001, 0.000001, -0.000000, 0.000001, -0.000001, 0.000001,
		0.000001, 0.000000, -0.000000, 0.000001, -0.000000, -0.000002, -0.000002, 0.000001, 0.000001, -0.000001, -0.000002, 0.000001,
		-0.000000, -0.000002, -0.000001, 0.000001, 0.000001, 0.000000, 0.000001, 0.000001, -0.000000, -0.000001, 0.000000, -0.000001,
		0.000000, -0.000000, -0.000000, -0.000001, 0.000000, 0.000001, -0.000001, -0.000001, 0.000000, 2.034856, -4.218244, 3.339176,
		-0.736695, 3.729079, -6.096030, 7.319124, -5.684996, 12.131605, -25.621355, 112.643883, 148.778185, 29.908955, -9.309856, -2.696156,
		70.922062, -65.234035, -58.460768, 78.452691, 93.720406, -46.683215, -35.774119, 17.248210, -13.693563, 1.842042, -20.382667, -34.389202,
		-1.896020, 9.529137, -10.465772, 3.585856, -1.535544, -3.808656, -9.923798, -12.872381, 12.387568, 10.914955, -4.286199, -6.673066,
		8.589575, 7.942860, 0.912517, 12.136931, 20.831140, 24.019551, 18.519528, 24.713524, 28.149951, 8.061331, -0.890598, 3.329998,
		1.166154, 5.666665, 6.651028, -2.920427, -8.263627, 2.118193, 1.357794, -1.771421, 0.030381, 0.909421, -1.726346, -4.940698,
		-0.425053, 5.290312, 3.099126, 1.342370, 4.976596, 3.363878, 0.613253, 4.065275, 0.610681, -3.434657, -0.099450, 3.060069,
		-0.114868, -1.709781, 2.383986, 3.352877, -0.044439, -1.915451, 0.473508, -1.585420, -1.835654, 0.501007, 1.793322, 1.850755,
		2.280725, 1.482384, -0.204674, 1.720559, 2.381739, 2.209286, 1.393962, 1.077123, 1.250972, 1.333847, 1.064161, -0.030292,
		0.397074, 0.436273, 0.368511, 0.542847, 0.893203, 0.784963, 0.206167, -0.425586, -0.771755, 0.233490, 0.033849, -0.273022,
		0.151749, 0.330853, 0.039120, 0.072404, 1.283724, 0.910658, 0.306375, -0.000000, -0.000001, 0.000000, 0.000000, -0.000002,
		0.000000, 0.000001, -0.000000, -0.000000};
	
	double hr[L] = {
		-0.000000, 0.000001, -0.000000, 0.000002, 0.000001, 0.000001, 0.000001, -0.000000, 0.000001, 0.000000, 0.000001, 0.000001,
		0.000000, 0.000002, 0.000002, -0.000000, -0.000001, -0.000001, 0.000002, 0.000001, -0.000000, 0.000001, 0.000000, -0.000000,
		-0.000001, -0.000001, 0.000000, 0.000001, -0.000001, -0.000000, -0.000000, 0.000001, -0.000001, -0.000000, 0.000001, 0.000002,
		0.000000, -0.000000, -0.000001, 0.000001, -0.000000, 0.000001, -0.000001, 0.000001, -0.000001, -0.000001, -0.000001, -0.000002,
		-0.000003, 0.000001, 0.000001, -0.000001, -0.000000, 0.000000, 0.000001, 0.000000, -0.000001, -0.000001, -0.000000, 0.000000,
		0.000001, -0.000000, -0.000001, 0.000001, 0.000001, -0.000000, -0.000001, -0.000000, 0.000000, -0.000001, -0.000001, -0.000000,
		0.000000, -0.000001, -0.000000, 0.000002, 0.000001, 0.000001, -0.000001, -0.000000, 0.000001, -0.000000, -0.000001, 0.000001,
		0.000000, 0.000001, -0.000001, 0.000000, 0.000002, -0.000000, 0.000000, 0.000001, 0.000000, -0.000000, 0.000000, 0.000001,
		0.000002, -0.000001, 0.000001, 0.000001, 0.000000, -0.000000, 0.000000, 0.000001, -0.000000, 0.000000, -0.000000, 0.000000, -0.000001, -0.000002, -0.000000, -0.000000, 0.000000, 0.000000, -0.000001, 0.000000, -0.000000, -0.000001,
		-0.000001, 0.000002, 0.000001, -0.000000, -0.000001, 0.000000, 0.000001, 0.000000, -0.000001, -0.000001, 0.000001, 2.422318, -4.437669, 2.997149, -0.830535, 4.446419, -5.531569, 5.504362, -5.492517, 12.255741, -21.635290, 86.922988,
		152.017280, 51.376402, -11.387762, -34.552701, 75.016528, -17.277844, -58.522247, 10.468218, 112.626344, 59.580795, -88.422447, -25.934879, 15.955817, -15.127208, -7.269590, -18.608488, -23.771932, -5.834332, -0.678696, 2.238445, 12.820356, -6.683432,
		-25.343629, 0.380828, 4.663489, -1.612529, 9.451791, 0.821706, -4.580544, 6.481560, 5.176924, 15.637774, 18.513829, 32.261971, 23.648228, 13.719397, 19.555207, 16.621051, 8.956989, -4.737667, -6.275194, 5.219429, 9.663356, -1.756625,
		-7.524305, 2.123916, 3.509006, -0.855840, 0.373240, 3.604609, -3.797821, -4.126895, -3.922008, -3.587800, 3.874276, 4.699291, 5.194706, 3.758404, 1.078022, -1.526791, 2.004512, 1.650844, -3.749898, 0.698557, 2.889269, -1.510697,
		-1.790374, 3.716535, 3.964745, -1.958277, -1.199561, -0.064671, -1.308069, -0.167294, 1.870757, 3.414322, 1.338040, 0.008669, 1.687670, 2.105111, 1.133872, 1.144427, 2.210130, 1.787866, 1.019882, 0.855750, 1.076044, 0.302711,
		-0.067716, 0.341353, 0.314020, 0.552193, 0.712502, 0.859306, 0.426590, -0.353263, -0.842677, -0.157085, 0.239537, 0.087182, 0.356574, 0.701874, 0.170969, -0.113580, 1.154375, 1.277450, 0.559154, -0.000001, -0.000001, -0.000000, 0.000000, -0.000001, 0.000000, 0.000001, 0.000000, -0.000001, 
	};

	filter2Complex(Hl, Hr, hl, hr, filterLenght);
	filterLRTime2Freq(Hl, Hr, exp);

}

void loadFiltersSurr(complex *Hl, complex *Hr, short exp, unsigned short filterLenght){
	double hl[L] = {
		-0.000001, -0.000000, 0.000000, 0.000000, 0.000001, 0.000000, 0.000000, -0.000000, -0.000000, -0.000000, -0.000001, -0.000001, 0.000001, 0.000001, -0.000001, -0.000001, -0.000001, 0.000001, 0.000000, 0.000000, -0.000001, -0.000000,
		-0.000001, 0.000001, -0.000000, 0.000001, -0.000000, -0.000000, -0.000000, -0.000000, -0.000000, 0.000001, 0.000002, 0.000000, -0.000001, 0.000001, 0.000002, -0.000001, -0.000001, 0.000000, 0.000001, -0.000001, -0.000001, -0.000000,
		-0.000000, -0.000002, -0.000001, -0.000000, 0.000001, -0.000000, 0.000000, 0.000001, 0.000000, -0.000001, 0.000001, 0.000001, 0.000000, -0.000000, -0.000000, 0.000000, 0.000001, 0.000000, 0.000001, 0.000001, -0.000000, -0.000000,
		-0.000000, 0.000001, 0.000001, -0.000000, -0.000001, -0.000000, 0.000001, 0.000001, 0.000001, 0.000001, -0.000002, -0.000001, -0.000000, 0.000000, 0.000002, -0.000000, -0.000001, 0.000001, -0.000001, -0.000000, 0.000001, 0.000001,
		-0.000001, -0.000000, 0.000001, 0.000001, -0.000000, -0.000000, 0.000001, 0.000000, 0.000000, 0.000000, 0.000001, -0.000000, -0.000001, -0.000000, -0.000001, 0.000000, 0.000001, 0.000001, -0.000001, 0.000002, -0.000001, -0.000001,
		-0.000001, 0.000001, 0.000001, 0.000000, -0.000000, 0.000002, 0.000000, -0.000001, -0.000001, 0.000000, -0.000000, 0.000000, -0.000001, 0.000001, 0.000002, -0.000001, -0.000002, 0.000000, 0.000001, 2.520173, -4.259702, 3.075086,
		-0.168363, 4.013946, -6.469547, 7.191647, -5.483688, 10.840492, -23.473339, 79.151503, 158.937920, 35.504682, -17.768427, 2.901003, 65.231679, -52.823285, -47.055093, 87.550783, 99.746985, -43.192530, -59.749887, 14.379123, -7.648210, -6.951187,
		-6.354092, -27.712195, 0.652999, 14.161672, -13.402320, -1.130904, -0.038574, -7.673340, -15.220822, -10.531738, 7.921571, 17.262028, 2.341816, -0.429231, 8.139746, 12.914858, 9.496177, 5.534216, 7.837985, 8.631761, 4.478302, 10.022678,
		18.371649, 17.229166, 17.303833, 10.197149, 1.318377, 3.754493, 3.462762, -2.306160, -5.166592, 3.828659, 6.725984, 7.192109, -0.422545, -2.197477, 1.375159, -0.396577, -1.412377, -1.136606, -0.973464, 0.559064, 4.111075, -1.092031,
		-1.092668, 2.907980, 3.448768, 1.055496, 0.500694, 1.348940, 1.116729, -1.028199, 0.522817, 4.063655, 2.357571, -0.346042, -1.118533, -1.486134, -0.837785, 0.170647, 0.786201, 0.969225, 2.010870, 2.006509, 0.582091, 1.372416,
		1.391404, 0.997731, 1.052961, 0.750685, 0.937669, 1.757402, 1.649233, 0.619228, 0.603628, 0.811173, 0.800294, 0.535761, 0.217597, 0.289246, 0.048618, -0.106373, 0.000826, 0.459612, 0.070554, -0.060540, -0.299857, -0.184378,
		-0.275105, -0.236529, 1.279586, 1.183834, 0.450987, -0.000000, -0.000000, -0.000000, -0.000001, 0.000000, 0.000001, -0.000000, -0.000002, -0.000000, 
	};

	double hr[L] = {
		-0.000001, -0.000000, 0.000001, 0.000001, -0.000001, 0.000000, 0.000000, -0.000000, -0.000001, -0.000000, 0.000001, 0.000000, 0.000001, 0.000001, 0.000001, -0.000001, 0.000002, -0.000000, -0.000000, 0.000001, 0.000000, -0.000002,
		-0.000002, -0.000001, 0.000000, 0.000001, 0.000000, -0.000001, 0.000000, -0.000000, 0.000000, -0.000000, 0.000001, 0.000000, 0.000001, 0.000000, 0.000001, 0.000001, 0.000000, 0.000000, 0.000000, 0.000000, -0.000001, 0.000000,
		-0.000002, 0.000001, -0.000002, -0.000002, -0.000001, 0.000000, -0.000001, -0.000000, -0.000002, -0.000000, 0.000000, 0.000000, -0.000000, -0.000001, 0.000000, 0.000000, -0.000002, -0.000002, -0.000000, 0.000000, -0.000000, -0.000000,
		0.000001, -0.000000, -0.000001, -0.000001, 0.000001, 0.000000, -0.000001, -0.000000, 0.000002, 0.000002, 0.000000, -0.000001, -0.000001, 0.000000, 0.000000, -0.000001, -0.000000, -0.000000, -0.000000, -0.000001, -0.000000, -0.000001,
		0.000001, 0.000001, 0.000000, -0.000001, 0.000000, -0.000000, -0.000000, 0.000001, 0.000002, 0.000001, 0.000000, 0.000001, -0.000001, -0.000000, -0.000000, -0.000000, -0.000000, 0.000001, -0.000000, 0.000001, 0.000001, -0.000002,
		-0.000001, -0.000001, -0.000001, 0.000001, -0.000001, -0.000001, 0.000001, -0.000000, -0.000001, -0.000000, -0.000001, 0.000000, 0.000001, 0.000000, 0.000000, 0.000000, 0.000001, -0.000000, 0.000000, 2.372341, -3.551294, 1.664503,
		0.277625, 4.034222, -4.550274, 4.161307, -3.731674, 8.669224, -14.968588, 45.578125, 152.875498, 70.181006, -19.905784, -23.663450, 62.635452, -1.413524, -45.617430, 11.206865, 104.833812, 70.217728, -82.651975, -47.596453, 12.110739, -11.617924,
		-1.943059, -2.134431, -21.554814, -7.068830, 2.310250, -1.082782, 7.346603, -3.569535, -27.786372, -8.416771, 3.858468, 2.917291, 14.100654, 7.965240, -1.002573, 4.751164, 12.259083, 9.625715, 6.576040, 10.726522, 8.865787, 14.236324,
		15.759294, 25.074694, 22.616760, 9.810629, -4.737640, 1.699462, 4.702230, -7.079776, -4.784099, 6.721679, 4.908888, -0.690849, 2.485588, 1.020338, 0.120403, -1.486082, -2.592225, -1.791298, 1.353688, -1.373103, 1.052747, 1.807566,
		-2.289060, 0.252901, 4.247647, 4.386068, 0.373261, -0.090353, 1.648842, 0.903865, 0.050077, 1.685810, 3.490354, 1.359864, -0.934394, -1.399855, -0.948508, -2.128832, 1.153425, 2.429599, 1.294056, 0.945591, 0.590390, 1.296493,
		1.058044, 1.079236, 1.362127, 1.059392, 0.586392, 1.054863, 1.481247, 1.366778, 0.683411, 0.512095, 0.424427, 0.898808, 0.859011, 0.284702, 0.026551, -0.254057, -0.125357, 0.595675, 0.627547, 0.165254, -0.423877, -0.242032,
		-0.204604, -0.161396, 0.997892, 1.246437, 0.550848, 0.000000, 0.000001, -0.000001, -0.000001, 0.000000, 0.000001, 0.000000, -0.000001, -0.000001, 
	};

	filter2Complex(Hl, Hr, hl, hr, filterLenght);
	filterLRTime2Freq(Hl, Hr, exp);
}

void filterAudio(complex *inOut, complex *fil, short exp, short *overlap, unsigned short m, unsigned char enable) {
	unsigned short n = 1 << exp;

	// Start fast  convolution
	// FFT
	bit_rev(inOut, exp);
	dft(inOut, exp, W);
	// Filter
	if (enable)
		freqfilter(inOut, fil, n);
	
	// IFFT
	bit_rev(inOut, exp);
	idft(inOut, exp, W);

	// overla for circular convolution
	olap_add(inOut, overlap, L, m, n);
}